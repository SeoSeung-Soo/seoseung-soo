{% extends "base.html" %}
{% load static %}
{% load product_filters %}

{% block title %}결제하기 - SeoSeung-Soo{% endblock %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/payments/payments.css' %}">
{% endblock %}

{% block content %}
<div class="payment-container">
    <div class="order-form">
        <div class="form-section">
        <div class="delivery-info-container">
            <div class="delivery-header">
                <h3 class="section-title">배송 정보</h3>
            </div>

            <form class="delivery-form">
                <div class="form-row">
                    <div class="form-label-cell">
                        <label class="form-label">받는사람<span class="required">*</span></label>
                    </div>
                    <div class="form-input-cell">
                        <input type="text" class="form-input" placeholder="이름을 입력해주세요" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-label-cell">
                        <label class="form-label">주소 <span class="required">*</span></label>
                    </div>
                    <div class="form-input-cell">
                        <div class="address-container">
                            <div class="postal-code-section">
                                <input type="text" class="form-input postal-code-input" placeholder="우편번호" readonly>
                                <button type="button" class="address-search-btn">주소검색</button>
                            </div>
                            <input type="text" class="form-input address-input" placeholder="기본주소" readonly>
                            <input type="text" class="form-input detail-address-input" placeholder="나머지 주소(선택 입력 가능)">
                        </div>
                    </div>
                </div>
            
            <div class="form-row">
                <div class="form-label-cell">
                    <label class="form-label">휴대전화 <span class="required">*</span></label>
                </div>
                <div class="form-input-cell">
                    <div class="phone-input-wrapper">
                        <input type="tel" class="form-input phone-input" placeholder="010" maxlength="3" required>
                        <span class="phone-separator">-</span>
                        <input type="tel" class="form-input phone-input" placeholder="1234" maxlength="4" required>
                        <span class="phone-separator">-</span>
                        <input type="tel" class="form-input phone-input" placeholder="5678" maxlength="4" required>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-label-cell">
                    <label class="form-label">이메일 <span class="required">*</span></label>
                </div>
                <div class="form-input-cell">
                    <div class="email-input-wrapper">
                        <input type="text" class="form-input email-input" placeholder="example" required>
                        <span class="email-at">@</span>
                        <select class="form-input email-domain">
                            <option value="naver.com">naver.com</option>
                            <option value="gmail.com">gmail.com</option>
                            <option value="daum.net">daum.net</option>
                            <option value="yahoo.com">yahoo.com</option>
                            <option value="custom">직접입력</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-label-cell">
                    <label class="form-label">메시지 선택</label>
                </div>
                <div class="form-input-cell">
                    <select class="form-input">
                        <option value="">-- 메시지 선택(선택사항) --</option>
                        <option value="door">문 앞에 놓아주세요</option>
                        <option value="security">경비실에 맡겨주세요</option>
                        <option value="call">배송 전 연락주세요</option>
                        <option value="custom">직접 입력</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-label-cell">
                </div>
                <div class="form-input-cell">
                    <label class="checkbox-label">
                        <input type="checkbox" class="checkbox-input">
                        <span class="checkbox-text">기본 배송지로 저장</span>
                    </label>
                </div>
            </div>
            </form>
        </div>
        </div>
        <div class="order-items-container">
        <div class="form-section">
            <h3 class="section-title">주문상품</h3>
            <div class="order-items">
                {% if order and order_items_with_products %}
                    {% for item_data in order_items_with_products %}
                    {% with item=item_data.item product=item_data.product %}
                    <div class="order-item">
                        {% if product and product.image.all %}
                            <img src="{{ product.image.first.image.url }}" alt="{{ item.product_name }}" class="item-image">
                        {% else %}
                            <div class="item-image no-image">이미지 없음</div>
                        {% endif %}
                        <div class="item-info">
                            <div class="item-name">{{ item.product_name }}</div>
                            {% if product and product.colors.all %}
                            <div class="item-color">
                                {% for color in product.colors.all %}
                                    <span class="item-color-circle" style="background-color: {% if color.hex_code %}{{ color.hex_code }}{% else %}#e5e7eb{% endif %};" title="{{ color.name }}"></span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="item-quantity">수량: {{ item.quantity }}개</div>
                            <div class="item-price">
                                {% if product %}
                                    {% if product.sale_price %}
                                        <span class="sale-price">{{ product.price|discount_amount:product.sale_price|intcomma }}원</span>
                                        <span class="original-price">{{ product.price|intcomma }}원</span>
                                    {% else %}
                                        <span class="current-price">{{ product.price|intcomma }}원</span>
                                    {% endif %}
                                {% else %}
                                    <span class="current-price">{{ item.unit_price|intcomma }}원</span>
                                {% endif %}
                            </div>
                            <div class="item-subtotal">
                                <span class="subtotal-label">소계:</span>
                                <span class="subtotal-value">
                                    {% if product and product.sale_price %}
                                        {% with discounted_price=product.price|discount_amount:product.sale_price %}
                                            {% widthratio discounted_price 1 item.quantity as item_total %}
                                            {{ item_total|intcomma }}원
                                        {% endwith %}
                                    {% elif product %}
                                        {% widthratio product.price 1 item.quantity as item_total %}
                                        {{ item_total|intcomma }}원
                                    {% else %}
                                        {{ item.subtotal|intcomma }}원
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                {% else %}
                    <div class="order-item">
                        <div class="item-info">
                            <div class="item-name">주문 정보가 없습니다.</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        </div>

        <div class="payment-info-container">
        <div class="form-section">
            <div class="shipping-info">
                <span class="shipping-label">배송비</span>
                <span class="shipping-value">
                    {% if order %}
                        {% if shipping_fee == 0 %}
                            0 (무료)원
                        {% else %}
                            {{ shipping_fee|intcomma }}원
                        {% endif %}
                    {% else %}
                        0원
                    {% endif %}
                </span>
            </div>
            
            {% if order %}
                <div class="payment-summary">
                    <div class="summary-row">
                        <span class="label">상품 금액:</span>
                        <span class="value">{{ actual_total|intcomma }}원</span>
                    </div>
                    <div class="summary-row">
                        <span class="label">배송비:</span>
                        <span class="value">
                            {% if shipping_fee == 0 %}
                                무료
                            {% else %}
                                {{ shipping_fee|intcomma }}원
                            {% endif %}
                        </span>
                    </div>
                    <div class="summary-row total">
                        <span class="label">총 결제 금액:</span>
                        <span class="value">{{ final_amount|intcomma }}원</span>
                    </div>
                </div>
            {% endif %}
            
            <div class="discount-section">
                <h4 class="discount-title">할인/부가결제</h4>
                <div class="discount-item">
                    <span class="discount-label">자동 할인</span>
                    <select class="discount-select">
                        <option value="0">할인 없음</option>
                    </select>
                </div>
                <div class="coupon-section">
                    <span class="coupon-label">할인코드 적용</span>
                    <div class="coupon-input-group">
                        <input type="text" class="coupon-input" placeholder="할인코드 입력">
                        <button type="button" class="coupon-btn">코드 적용</button>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <div class="payment-method-container">
        <div class="form-section">
            <h3 class="section-title">결제 방법</h3>
            <div class="payment-methods">
                <label class="payment-method">
                    <input type="radio" name="payment-method" value="toss" checked>
                    <span class="payment-method-label">토스페이</span>
                    <span class="payment-method-desc">간편한 토스 결제</span>
                </label>
                
                <label class="payment-method">
                    <input type="radio" name="payment-method" value="bank">
                    <span class="payment-method-label">무통장 입금</span>
                    <span class="payment-method-desc">가상계좌 입금</span>
                </label>
            </div>
        </div>
        </div>
        <div class="payment-button-container">
        <div class="payment-section">
            {% if order %}
                <button type="button" class="payment-button" id="tossPaymentBtn" data-order-id="{{ order.order_id }}" data-amount="{{ final_amount }}">
                    <span class="payment-text">{{ final_amount|intcomma }}원 결제하기</span>
                </button>
            {% else %}
                <button type="button" class="payment-button" disabled>
                    <span class="payment-text">주문 정보가 없습니다.</span>
                </button>
            {% endif %}
            <div class="terms-agreement">
                <p>결제하기 버튼을 클릭하시면 <a href="#">이용약관</a> 및 <a href="#">개인정보처리방침</a>에 동의하는 것으로 간주됩니다.</p>
            </div>
        </div>
        </div>
        </div>
    </div>
</div>

<!-- Toss Payments 설정 (항상 생성) -->
<input type="hidden" id="tossClientKey" value="{% if TOSS_CLIENT_KEY %}{{ TOSS_CLIENT_KEY }}{% endif %}">
{% if order %}
<input type="hidden" id="orderId" value="{{ order.order_id }}">
<input type="hidden" id="orderAmount" value="{{ final_amount }}">
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://js.tosspayments.com/v1/payment"></script>
<script src="{% static 'js/payments/payments.js' %}" defer></script>
{% endblock %}